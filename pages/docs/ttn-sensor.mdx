---
layout: 'docs'
title: 'Neuen TTN-Sensor anlegen'
metaTitle: 'Neuer TTN-Sensor'
metaDescription: 'Folge dieser einfachen Schritt-für-Schritt-Anleitung, um einen neuen TTN-Sensor auf Stadtpuls hinzuzufügen.'
---
  
<p className="lead">
  Wie du deine TTN-Sensoren mit Stadtpuls reden lässt.
</p>

Bislang verfügt *Stadtpuls* über zwei verschiedene Integrationsmöglichkeiten:
1. die TTN-Integration von The Things Network
2. eine HTTP-Integration mittels RESTful-API

Du hast bereits eigene Sensoren bei <a href="https://www.thethingsnetwork.org/" target="_blank">The Things Network</a>? Fantastisch! In dieser Sektion erklären wir wie du deinem Account Leben einhauchen und deine TTN-Sensoren in nur wenigen Minuten zu *Stadtpuls* hinzufügen kannst. 

Du hast keine Ahnung was *The Things Network* sein soll möchtest aber trotzdem einen Sensor auf *Stadtpuls* registrieren? Dann ist unsere <a href="/docs/http-sensor">HTTP-Integration</a> vielleicht ein guter Start für dich.

In dieser Sektion erklären wir, wie du deinem Account einen neuen Sensor mittels TTN-Integration hinzufügen kannst. Alles in Allem besteht die Einrichtung aus drei essentiellen Schritten:
1. Sensor auf *Stadtpuls* hinzufügen
2. TTN Webhook einrichten
3. TTN Payload Formatter einrichten

Und lost geht's mit Schritt numero uno!

## 1. TTN-Sensor zu Stadtpuls hinzufügen
Klicke dazu in der Menüleiste oben rechts auf dein **Account-Icon** und dann auf **Neuer Sensor**. 
Dir wird nun die Eingabemaske für den neuen Sensor angezeigt. 
   <figure>
  <img style={{maxHeight: 400, border: '1px solid rgba(0, 0, 0, 0.05)'}}
    src="/images/newDeviceTTN.png"
    alt="neuen Sensor hinzufügen"
  />
    <figcaption>
    Eingabemaske, um einen neuen Sensor auf <em>Stadtpuls</em> hinzuzufügen
  </figcaption>
  </figure>

Wähle als Typ der Integration **TTN** aus und trage alle weiteren Informationen in das Formular ein. Keine Angst! Du kannst alle Angaben wie **Name**, **Beschreibung**, **Standort** und **Kategorie** deines Sensors nachträglich ändern und anpassen.

### Die richtige Sensor-ID 
Um deine TTN-Sensoren mit *Stadtpuls* erfolgreich verknüpfen zu können ist es wichtig, dass du als **Device-ID** die exakt gleiche Device-ID wie die aus deiner TTN-Applikation nutzt.
Diese Device-ID findest du im persönlichen Account auf <a href="https://www.thethingsnetwork.org/" target="_blank">The Things Network</a>, nicht auf *Stadtpuls*.
Ein kleines Beispiel: dein Sensor heißt in deiner TTN-Konsole `node-temp-001`. Demnach lautet deine Device-ID in Stadtpuls ebenfalls `node-temp-001`. Klicke nun auf **Hinzufügen**.

Hurray, how easy was that! Du hast deinem Account einen neuen Sensor hinzugefügt.

Damit Dein TTN-Sensor mit jedem Messwert automatisch einen POST-Request an unsere *Stadtpuls* API stellt und die Sensormesswerte in unserer Datenbank ankommen, muss nun noch der **TTN-Webhook** eingerichtet werden.

## 2. TTN-Webhook einrichten
*Die nachfolgende Dokumentation basiert auf der neuen **The Things Stack Community Edition**, auch TTN V3 genannt. Stadtpuls funktioniert zwar auch mit dem alten TTN Stack (V2), unterstützt aber in der Doku und der weiteren Entwicklung ausschließlich TTN V3.*

Die Konfiguration der Webhook-Integration ist kein Hexenwerk und schnell erledigt.
First things first:

1. Logge dich auf <a href="https://www.thethingsnetwork.org/" target="_blank">https://www.thethingsnetwork.org/</a> in deinen TTN-Account ein
2. Navigiere zu deiner TTN-Applikation, die du mit Stadtpuls verknüpfen möchtest
3. In der linken Seitenleiste siehst du einen Menüpunkt namens **Integrations**. Klicke darauf, um das Dropdown-Menü zu öffnen und klicke anschließend auf **Webhooks**

Dort angekommen, kannst du einen neuen TTN-Webook für deine TTN-Applikation einrichten. Klicke dazu auf **Add Webhook** und wähle **Custom Webhook** aus. 

### Webhook Parameter

Die **Webhook ID**, respektive der Name deines Webhooks, ist frei wählbar und ganz dir überlassen. Das **Webhook format** ist JSON.

&#x1f4a1; Was beim TTN V3 Stack der Webhook ist, war beim TTN V2 Stack die HTTP-Integration. Die Funktionsweise ist die gleiche: sowohl die HTTP-Integration als auch der Webhook können *POST* und *GET* Operationen über HTTP an einem bestimmten Endpoint ausführen.

Unter den Endpoint Settings muss nun der API-Endpoint konfiguriert werden. In unserem Falle nutzen wir als **Base URL** des Endpoints die RESTful API von Stadtpuls: 

```shell
https://api.stadtpuls.com/
```

Wir übergeben der API jedoch noch eine zusätzliche Information – **Additional headers** mit dem Namen *authorization* im Header: nämlich einen Authorizierungs-Token.
Navigiere zu deinem Stadtpuls-Account, klicke auf **Tokens** und erstelle dir einen neuen Token für deinen Sensor.

**&#x26a0; Wichtig** kopiere dir den Token in deine Zwischenablage!

   <figure>
  <img style={{maxHeight: 400, border: '1px solid rgba(0, 0, 0, 0.05)'}}
    src="/images/ttnWebhook2.png"
    alt="Konfiguration der TTN-Webhook-Integration"
  />
    <figcaption>
    So sieht die Konfiguration der TTN-Webhook-Integration aus
    </figcaption>
  </figure>

Füge diesen Token mit dem Zusatz `Bearer ` am Anfang des Textes in das Eingabefeld. Solltest du deinen Token verloren haben, kannst du dir in deinem Account einen neuen Token generieren lassen. 

Schließlich müssen wir dem Webhook noch mitteilen, bei welcher Art von Events er getriggert werden soll. In unserem Fall möchten wir bei jedem Uplink, also bei jedem Datenpaket, welches in der TTN-Applikation ankommt, einen POST-Request auf unsere Stadtpuls-API ausführen. Der Endpoint dafür lautet

```shell
/api/v3/integrations/ttn/v3
```

   <figure>
  <img style={{maxHeight: 400, border: '1px solid rgba(0, 0, 0, 0.05)'}}
    src="/images/ttnMessages.png"
    alt="Konfiguration der TTN-Webhook-Integration"
  />
    <figcaption>
    Der Webhook wird bei Uplinks der Sensoren getriggert
    </figcaption>
  </figure>

Speichern nicht vergessen und weiter geht's mit dem dritten und letzten Schritt.

## 3. Payload Formatter einrichten
Der <a href="https://www.thethingsindustries.com/docs/integrations/payload-formatters/create/" target="_blank">Payload Formatter von TTN</a> ermöglicht es den TTN-Nutzer:innen ihre Uplinks und Downlinks zu formattieren. Dabei sind Uplinks all' die Payloads (Datenpackete) die von einem Sensor zu einem Gateway geschickt werden, wohingegen Downlinks all' jene Payloads sind, die von einem Gatway zu einem Sensor geschickt werden.
Wir interessen uns bei Stadtpuls für alle Messwerte der einzelnen Sensore – also für alle Uplinks. 


### Payload packen

Mit Hilfe des Payload Formatters kann jedes einzelne Byte des Uplinks in ein menschelesbares Format gebracht werden. Dabei ist es wichtig zu wissen, wie sich das Datenpaket bzw. der Uplink meines Sensors überhaupt zusammensetzt. Das nachfolgenden Beispiel (geschrieben als Arduino Code) zeigt beispielhaft wie ein Datenpaket mit insgesamt vier Messwerten (temperatur, airpressure, humidity, dezibel) in ein Payload gepackt werden kann.

```shell
void generate_payload(float temperature, float airpressure, float humidity, float dezibel) {

  uint8_t payload[7];
  
  int tmp = ((int)(temperature * 100)) + 5000;
  int pressure = (int)(airpressure * 10);
  byte hum = (int)(humidity * 2);
  int dezi = (int)(dezibel * 10);

  payload[0] = tmp >> 8;
  payload[1] = tmp;
  payload[2] = pressure >> 8;
  payload[3] = pressure;
  payload[4] = hum;
  payload[5] = dezi >> 8;
  payload[6] = dezi;

  int i = 0;
  while (i < sizeof(payload)) {
    tx_payload[i] = payload[i];
    i++;
  }
}
```

Der Payload besteht schließlich aus insgesamt 7 Bytes, wobei:
- *temperature* als Integer durch das erste und zweite Byte, 
- *airpressure* als Integer durch das dritte und vierte Byte,
- *humidity* als einzelner Byte durch Byte fünf und 
- *dezibel* als Integer wieederumg durch Byte sechs und sieben

beschrieben wird. Jede:r *Stadtpuls*-Nuter:in kann seine/ihre Datenpacket natürlich wie er oder sie möchte packen und versenden. Wichtig ist allerdings zu wissen, an welcher Stelle (an welchem Byte) im Payload welcher Messwert steht. Mit diesem Wissen können wir den Payload nämlich nach Übertragung an das LoRaWan-Gateway ordentlich decodieren und mit Hilfe des Payload Formatters so formattieren, dass unsere *Stadtpuls*-API den Payload richtig interpretieren kann.

### Payload entpacken
Die Daten, die in der TTN-Applikation ankommen wurden bereits von TTN entschlüsselt und sind hexadezimale Darstellungen der entschlüsselten "Binärdaten". Dabei stellen zwei Characters (Zahlen oder Buchstaben) ein Byte dar. 
   <figure>
  <img style={{maxHeight: 400, border: '1px solid rgba(0, 0, 0, 0.05)'}}
    src="/images/ttnHexa.png"
    alt="Hexadezimale Darstellung des Payloads '12 A3 B9 77'"
  />
    <figcaption>
    Hexadezimale Darstellung des Payloads '12 A3 B9 77'
    </figcaption>
  </figure>

Mit Hilfe des Payload Formatters können wir die Hexadezimalwerte in menschenlesbare Werte übertragen und für unsere API aufbereiten.
Unsere RESTful API von *Stadtpuls* erwartet genau einen Wert: **ein Array vom Typ Float mit dem namen 'measurements'**

Passend zum gepackten Payload oben, muss die Payload Function also wie folgt aussehen:

```shell
function decodeUplink(input) {
  var dezi = input.bytes[0];
  
  return {
    data: {
      bytes: input.bytes,
      measurements: [dezi]
    },
    warnings: [],
    errors: []
  };
}
```
In der Konsole sollte nun der Hexadezimalwert '12 A3 B9 77' im Array *measurements* als Dezimalzahl (4676) dargestellt werden.
   <figure>
  <img style={{maxHeight: 400, border: '1px solid rgba(0, 0, 0, 0.05)'}}
    src="/images/ttnDezimal.png"
    alt="Dezimale Darstellung des Payloads '12 A3 B9 77'"
  />
    <figcaption>
    Dezimale Darstellung des Payloads '12 A3 B9 77'
    </figcaption>
  </figure>

In diesem Falle hat unsere Sensor also den Messwert '4676' gemessen. Da der Wert im Array **measurements** abgespeichert wurde, wird er schließlich auch als Messwert von unserer API richtig interpretiert und deinem Sensor zugeordnet.

Du hast es bis hierhin geschafft? Hurray! Dann hast du deinen TTN-Sensor erfolgreich mit *Stadtpuls* verknüpft.